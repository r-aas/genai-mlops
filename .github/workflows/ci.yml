# ─────────────────────────────────────────────────────────────────────────────
# CI — Validate Compose config + lint Dockerfile on every PR and push to main
# ─────────────────────────────────────────────────────────────────────────────
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate placeholder secrets for CI
        run: |
          mkdir -p secrets
          for f in n8n_postgres_password mlflow_postgres_password minio_root_password n8n_encryption_key; do
            echo "ci-placeholder" > "secrets/$f"
          done

      - name: Validate docker-compose.yml
        run: docker compose config --quiet

      - name: Check for hardcoded secrets in compose
        run: |
          if grep -E '^\s+(POSTGRES_PASSWORD|MINIO_ROOT_PASSWORD|N8N_ENCRYPTION_KEY)\s*[:=]' docker-compose.yml | grep -v '_FILE' | grep -v '/run/secrets'; then
            echo "::error::Hardcoded secret found in docker-compose.yml"
            exit 1
          fi
          echo "✓ No hardcoded secrets in docker-compose.yml"

      - name: Validate init-secrets.sh generates correct files
        run: |
          rm -rf secrets
          bash scripts/init-secrets.sh
          for f in n8n_postgres_password mlflow_postgres_password minio_root_password n8n_encryption_key; do
            if [ ! -f "secrets/$f" ]; then
              echo "::error::init-secrets.sh failed to create secrets/$f"
              exit 1
            fi
            if [ "$(stat -c '%a' "secrets/$f")" != "600" ]; then
              echo "::error::secrets/$f permissions should be 600"
              exit 1
            fi
          done
          echo "✓ init-secrets.sh generates all secrets with correct permissions"

      - name: Docker Compose build (smoke test)
        run: docker compose build --quiet

  lint-dockerfile:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Lint MLflow Dockerfile with hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: mlflow/Dockerfile
          ignore: DL3013,DL3042
